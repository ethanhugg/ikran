<html>
<head>
    <title>Sample ROAP Gateway Client!</title>
    <script src='jquery-1.6.2.js'></script>
    <script src='jquery-ui-1.8.16.custom.min.js'></script>
    <script src='json2.js'></script>

 <script type="application/javascript;version=1.8">
        let ikranService = window.navigator.service.call;
    </script>

</head>
<body onLoad="pageLoad()" style="margin:10px 0px;padding:0px;text-align:center;">
	<h2>ROAP GATEWAY CLIENT SAMPLE</h2>
    <h3> ( not a complete ROAP client ) <h3>
	<canvas id="thecanvas" width="640" height="480"></canvas>
    <div>
	<p><input type="button" id="roaptestbutton" value="Start ROAP Media"/></p>
    </div>
	<p id='tehmsg'/>
    <div id='ajax-status'>This is ajax status DIV </div>
</body>
<script type="application/javascript;version=1.8">
    let img = new Image();
    let roaptestbut = document.getElementById("roaptestbutton");
    let ctx = document.getElementById("thecanvas").getContext("2d");
    let msg = document.getElementById("tehmsg");
	var pc; 
	var poll_again = true;
	var poll_timeout = 1000;
	var audioTxPort = 16384;
    var videoTxPort = 1024;
    var peerIp = "127.0.0.1";
    var isROAPMediaOn = false;

	// JUST ENUF PEER CONNECTION CLASS
	var PeerConnection = function(signalingCallback) {

		var addStream = function() {
			//hardcoded offer, call the signaling callback
			msg.innerHTML=" In Add Stream ";	
			//parseSDP(JSON.parse(JSON.stringify(make_offer())));
			signalingCallback(make_offer());	
		};

		var removeStream = function() {
			//not yet implemented
		};

    	var processMessage = function(message) {
			if(message.messageType == "OFFER")
			{
				//not yet implemented
				poll_again = true;
			}	
			else if(message.messageType == "ANSWER")
			{
				processAnswer(message);
				signalingCallback(make_ok())
				poll_again = false;
			}else if(message.messageType == "OK") 
			{
				alert(" Got OK message ");
				poll_again=true;
			}else 
			{
				alert("Got message :" + message.messageType);
				//let's poll again
				poll_again = true;
			}
		}; 


    	var make_offer = function() {
			return {
				messageType:"OFFER",
				callerSessionId:"1023",
				seq:"7222",
				sdp:"v=0 \
					o=Cisco-SIPUA 13578 0 IN IP4 171.68.20.199 \
					s=SIP Call \
					t=0 0 \
					m=audio 8800 RTP/AVP 0 8 9 101 \
					c=IN IP4 171.68.20.199 \
					a=rtpmap:0 PCMU/8000 \
					a=rtpmap:8 PCMA/8000 \
					a=rtpmap:9 G722/8000 \
					a=rtpmap:101 telephone-event/8000 \
					a=fmtp:101 0-15 \
					a=sendrecv \
					m=video 9900 RTP/AVP 97 \
					c=IN IP4 171.68.20.199 \
					a=rtpmap:97 H264/90000 \
					a=fmtp:97 profile-level-id=42E00C \
					a=sendrecv"	
			};
		};

		var make_ok = function() {
	 		return {
       	    	 messageType:"OK",
            	callerSessionId:"1023",
            	seq:"7222"
        	};
		};

		var make_answer = function() {

			//not yet implemented
		};

		var processAnswer = function(message) {
			var sdp = message.sdp;
			parseSDP(sdp);
		};

		var parseSDP = function(sdp)
		{
			alert(sdp.sdp);
			var sdp = sdp.sdp;
			//get IP address
			var ipIdx = sdp.search(/IP4/);	
			peerIp = sdp.substring(ipIdx+4, ipIdx+20); 
			alert("IP Address " + peerIp);
			//get m= lines
			var aIdx = sdp.search(/m=audio/);
			audioTxPort = sdp.substring(aIdx+8,aIdx+13); 	
			alert("Audio TxPort " + audioTxPort);
			var vIdx = sdp.search(/m=video/);
			videoTxPort = sdp.substring(vIdx+8,vIdx+13); 	
			alert("Video TxPort " + videoTxPort);
			
		};

		return {
			addStream: addStream,
			removeStream: removeStream,
			processMessage: processMessage
		};

};

	//TRANSPORT and POLL


	function xport_success(msg)
	{
		pc.processMessage(JSON.parse(JSON.stringify(msg)));
		alert("poll again is " + poll_again);
		if(poll_again == true) {
			poll();
		} else {
			//we got the answer
			alert("Video port is" + videoTxPort);
				
		}
			
	}


	function xport_error(msg)
	{
		//... lets just poll
		setTimeout(poll, poll_timeout);
	}
	
	function sig_transport(params)
	{
		if (params.type == "POST") 
		{
			   $.ajax({
                type:"POST",
                url: "/roap.php",
                dataType: "json",
				data: params.data,
                contentType: "application/json",
                success:xport_success,
                error:xport_error
			});
		}else
		{
			   $.ajax({
                type:"GET",
                url: "/roap.php",
                dataType: "json",
                contentType: "application/json",
                success:xport_success,
                error:xport_error
               	}); 

		}


	}


	function poll()
	{
		sig_transport({
		 type: "GET"
	     });
	}


	function signalingChannelCb(msg) 
	{
		alert(" signalingChannelCb " + JSON.stringify(msg));
		sig_transport({
		     type: "POST",
			data:  JSON.stringify(msg) 
			});
	}


	function InitROAPClient()
	{
        // Let the ROAP client know abt itself
        ikranService.initROAPClient();
        
		//create peer connection object
		pc = new PeerConnection(signalingChannelCb);	
	}

	function pageLoad() {
		InitROAPClient();	
    }

	img.onload = function() { ctx.drawImage(img, 192, 112); }

    if (!ikranService) {
        alert(" The Ikran add-on could not be loaded ! ");
    }
    
    roaptestbut.onclick = function() {
    //please note this code is not a complete ROAP client
        if(isROAPMediaOn == true)
        {
            //let's ed the media
            // send ROAP:Shutdown via pc.removeStream()
            ikranService.stopROAPMedia();
            isROAPMediaOn = false;
            roaptestbut.value = "Start ROAP Media ";
        
        } else
        {
            //pc.addStream();
		    //msg.innerHTML = " Starting the media now ";
            //poll();
            audioTxPort = 5555;
            videoTxPort = 6666;
            ikranService.startROAPMedia(ctx,"127.0.0.1",audioTxPort,audioTxPort,videoTxPort,videoTxPort);
            isROAPMediaOn = true;
            roaptestbut.value = " Stop ROAP Media ";
        }
  }
</script>
</html>
